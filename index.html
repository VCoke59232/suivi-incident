
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Suivi des Incidents</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; color: #333; }
    #header { text-align:center; margin-bottom:20px; }
    #header img { height:80px; display:block; margin:0 auto 10px auto; }
    h1 { text-align: center; color: #2c3e50; margin:0; }
    h2 { margin-top: 30px; color: #34495e; }
    .controls { text-align:center; margin-bottom:12px; }
    form { background: #fff; padding: 18px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); max-width: 920px; margin: auto; display:flex; gap:16px; flex-wrap:wrap; }
    .col { flex:1 1 280px; min-width:240px; }
    label { display:block; margin-top: 8px; font-weight:600; font-size:13px; color:#334155; }
    input, select, textarea { width:100%; padding:8px; margin-top:6px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; }
    textarea { min-height:80px; }
    .actions { display:flex; gap:8px; align-items:center; }
    button { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    button.primary { background:#4c1d95; color:#fff; }
    button.secondary { background:#e5e7eb; color:#111827; }
    #alert { display:none; background:#fff3cd; color:#856404; border:1px solid #ffeeba; padding:10px; border-radius:8px; margin:10px auto; max-width:920px; text-align:center; }
    #incidents { margin-top:20px; max-width:1100px; margin-left:auto; margin-right:auto; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; max-width:1100px; margin:0 auto 10px auto; }
    .incident { background:#fff; padding:14px; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,0.06); display:flex; justify-content:space-between; gap:12px; align-items:flex-start; border-left:6px solid #4c1d95; }
    .incident .infos { flex:1; }
    .incident .meta { color:#475569; font-size:13px; margin-top:8px; }
    .styled-table { border-collapse: collapse; margin: 14px 0; font-size: 14px; width:100%; box-shadow: 0 0 8px rgba(0,0,0,0.06); border-radius:8px; overflow:hidden; }
    .styled-table thead th { background:#4c1d95; color:#fff; padding:10px; text-align:left; font-weight:600; }
    .styled-table tbody td { padding:10px; border-bottom:1px solid #e6eaf0; }
    .styled-table tbody tr:nth-child(even) { background:#f8fafc; }
    .styled-table tbody tr:hover { background:#eef2ff; }
    .hidden { display:none; }
    @media (max-width:800px){ form{flex-direction:column;} .topbar{flex-direction:column; align-items:stretch;} }
  </style>
  <!-- CSS Choices -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
</head>
<body>
  <div id="header">
    <img src="logo.png" alt="Logo UP MRE" onerror="this.style.display='none'">
    <h1>üìä Suivi des Incidents</h1>
  </div>

  <div id="alert">‚ö†Ô∏è Les donn√©es affich√©es proviennent des valeurs par d√©faut (fichiers JSON non charg√©s). <button id="reloadBtn" style="margin-left:12px;">üîÑ Recharger</button></div>

  <div class="topbar">
    <div class="controls">
      <button class="primary" id="btnNew">‚ûï Nouvel incident</button>
      <button class="secondary" id="btnHistory">üìú Historique</button>
    </div>
    <div style="text-align:right;">
      <button id="exportBtn" class="secondary">üíæ Export JSON</button>
      <button id="importBtn" class="secondary">üìÇ Import JSON</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none">
    </div>
  </div>

  <div id="mainApp">
    <form id="incidentForm" autocomplete="off">
      <div class="col">
	    <label>Lieu</label>            <select id="lieu"></select>  
        <label>√âquipement</label>      <input id="equipement" required>
        <label>Date de l'incident</label>    <input id="dateIncident" type="date">		
		<label>Description de l'incident</label>    <textarea id="description"></textarea>
		 <label for="lieu">Choisissez une ville :</label> <select id="lieu" placeholder="S√©lectionnez une ville"  </select>
		

      </div>
      <div class="col">
        <label>Type</label>       <select id="type"></select>
        <label>Gravit√©</label>     <select id="gravite"></select>
        <label>Astreinte</label>   <select id="astreinte"></select>
        <label>Status</label>      <select id="status"></select>
        <label>Date de cl√¥ture</label>    <input id="closureDate" type="date">
      </div>
      <div class="col">
        <label>√âquipe</label>          <select id="equipe"></select>
		<label>Date d'intervention</label>    <input id="interventionDate" type="date">
		<label>Commentaire intervention</label>     <textarea id="commentaire"></textarea>

        <div class="actions" style="margin-top:12px;">
          <button type="submit" class="primary">üíæ Enregistrer</button>
          <button type="button" id="cancelBtn" class="secondary">‚ùå Annuler</button>
        </div>
      </div>
    </form>
  </div>

  <div id="historique" class="hidden">
    <h2>üìú Historique des incidents</h2>
    <label for="filterLieu">Filtrer par lieu :</label>
    <select id="filterLieu"><option value="">-- Tous les lieux --</option></select>

    <table id="tableHistorique" class="styled-table" style="width:100%; margin-top:12px;">
      <thead>
        <tr><th>Date cr√©ation</th><th>Date cl√¥ture</th><th>Lieu</th><th>√âquipe</th><th>Type</th><th>Gravit√©</th><th>Status</th><th>Commentaire</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="secondary" id="btnBack">‚¨Ö Retour</button>
  </div>

  <div id="incidents"></div>

<script>
let incidents = [];
let fallbackUsed = false;
const defaults = {
  "lieu.json": ["Atelier","Entrep√¥t","Salle Serveurs","Bureau","Ext√©rieur"],
  "equipe.json": ["√âquipe Maintenance","√âquipe R√©seau","√âquipe S√©curit√©","√âquipe Production"],
  "type.json": ["Panne","Maintenance","S√©curit√©","Autre"],
  "gravite.json": ["Faible","Moyenne","Critique"],
  "astreinte.json": ["Oui","Non"],
  "status.json": ["Ouvert","Clos"]
};
function el(id){ return document.getElementById(id); }
function showAlert(){ el('alert').style.display='block'; }
function hideAlert(){ el('alert').style.display='none'; }
async function loadOptions(file, selectId){
  const select = el(selectId);
  try{
    const res = await fetch(file);
    if(res.ok){ const values = await res.json(); fillSelect(select, values); return; }
  }catch(e){ console.warn('loadOptions failed', file); fallbackUsed=true; showAlert(); }
  if(defaults[file]) fillSelect(select, defaults[file]);
}
function fillSelect(select, values){
  select.innerHTML='';
  values.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o); });
}
async function loadFromFile(){
  try{
    const res = await fetch('incidents.json');
    if(res.ok){ incidents = await res.json(); render(); }
  }catch(e){ console.warn('no incidents.json'); }
}
function saveData(download=true){
  try{ localStorage.setItem('incidents_v6', JSON.stringify(incidents)); }catch(e){}
  if(download){
    const blob = new Blob([JSON.stringify(incidents,null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='incidents.json'; a.click();
  }
}
function render(){ const c = el('incidents'); c.innerHTML=''; incidents.forEach((inc,i)=>{ const d = document.createElement('div'); d.className='incident'; d.innerHTML = `<div class="infos"><strong>#${i+1} - ${escapeHtml(inc.equipement||'--')}</strong><div class="meta">üìç ${escapeHtml(inc.lieu||'--')} | üë• ${escapeHtml(inc.equipe||'--')} | üìÖ ${escapeHtml(inc.dateIncident||'--')}</div><div class="meta">‚ö° ${escapeHtml(inc.type||'--')} | üî• ${escapeHtml(inc.gravite||'--')} | ‚òéÔ∏è ${escapeHtml(inc.astreinte||'--')}</div><div class="meta">Status: ${escapeHtml(inc.status||'--')} | Cl√¥ture: ${escapeHtml(inc.closureDate||'--')}</div><p><b>Description:</b> ${escapeHtml(inc.description||'')}</p><p><b>Commentaire:</b> ${escapeHtml(inc.commentaire||'')}</p></div>`; c.appendChild(d); }); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])); }
el('incidentForm').addEventListener('submit', function(e){ e.preventDefault(); const inc = { equipement: el('equipement').value.trim(), lieu: el('lieu').value, equipe: el('equipe').value, dateIncident: el('dateIncident').value, type: el('type').value, gravite: el('gravite').value, astreinte: el('astreinte').value, status: el('status').value, closureDate: el('closureDate').value||'', description: el('description').value.trim(), commentaire: el('commentaire').value.trim(), createdAt: new Date().toISOString() }; if(inc.status.toLowerCase().startsWith('clos') && !inc.closureDate){ const d = new Date(); inc.closureDate = d.toISOString().slice(0,10); } incidents.push(inc); render(); saveData(true); alert('Incident enregistr√© et JSON g√©n√©r√©.'); el('incidentForm').reset(); });
el('cancelBtn').addEventListener('click', ()=>{ el('incidentForm').reset(); });
el('status').addEventListener('change', ()=>{ const s = el('status').value.toLowerCase(); el('closureDate').disabled = !(s.indexOf('clos')>=0 || s.indexOf('ferme')>=0); });
function showHistorique(){ el('mainApp').classList.add('hidden'); el('historique').classList.remove('hidden'); populateFilterLieu(); afficherHistorique(incidents); }
function hideHistorique(){ el('historique').classList.add('hidden'); el('mainApp').classList.remove('hidden'); }
function populateFilterLieu(){ const select = el('filterLieu'); select.innerHTML = '<option value="">-- Tous les lieux --</option>'; const opts = Array.from(el('lieu').options).map(o=>o.value); opts.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o); }); }
function afficherHistorique(data){ const tbody = document.querySelector('#tableHistorique tbody'); tbody.innerHTML=''; data.forEach(inc=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(inc.createdAt?inc.createdAt.slice(0,10):'')}</td><td>${escapeHtml(inc.closureDate||'')}</td><td>${escapeHtml(inc.lieu||'')}</td><td>${escapeHtml(inc.equipe||'')}</td><td>${escapeHtml(inc.type||'')}</td><td>${escapeHtml(inc.gravite||'')}</td><td>${escapeHtml(inc.status||'')}</td><td>${escapeHtml(inc.commentaire||'')}</td>`; tbody.appendChild(tr); }); }
function filtrerHistorique(){ const lieu = el('filterLieu').value; const data = incidents.filter(i=> !lieu || i.lieu===lieu); afficherHistorique(data); }
el('exportBtn').addEventListener('click', ()=> saveData(true));
el('importBtn').addEventListener('click', ()=> el('fileInput').click());
el('fileInput').addEventListener('change', function(e){ const f = this.files[0]; if(!f) return; const r = new FileReader(); r.onload = ()=>{ try{ incidents = JSON.parse(r.result); render(); }catch(err){ alert('Erreur lecture JSON'); } }; r.readAsText(f); });
el('reloadBtn').addEventListener('click', ()=>{ loadOptions('lieu.json','lieu'); loadOptions('equipe.json','equipe'); loadOptions('type.json','type'); loadOptions('gravite.json','gravite'); loadOptions('astreinte.json','astreinte'); loadOptions('status.json','status'); loadFromFile(); });
el('btnHistory').addEventListener('click', showHistorique);
el('btnNew').addEventListener('click', ()=>{ hideHistorique(); });
window.addEventListener('DOMContentLoaded', ()=>{ loadFromFile(); loadOptions('lieu.json','lieu'); loadOptions('equipe.json','equipe'); loadOptions('type.json','type'); loadOptions('gravite.json','gravite'); loadOptions('astreinte.json','astreinte'); loadOptions('status.json','status'); try{ const saved = localStorage.getItem('incidents_v6'); if(saved){ incidents = JSON.parse(saved); render(); } }catch(e){} });
   
   // Initialisation de Choices
    const selectlieu = new Choices('#lieu', {
      searchEnabled: true,      // active le champ de recherche
      itemSelectText: '',       // enl√®ve le texte "Appuyez pour s√©lectionner"
      placeholderValue: 'Choisissez une ville', 
      noResultsText: 'Aucun r√©sultat', 
      noChoicesText: 'Aucune option disponible',
      shouldSort: false         // garde l‚Äôordre initial des options
    });


</script>
</body>
</html>
