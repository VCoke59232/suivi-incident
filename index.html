<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi des Incidents - UP MRE</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f7fa; margin:0; }
    header { background:#003366; color:white; padding:15px; display:flex; align-items:center; }
    header img { height:50px; margin-right:15px; }
    header h1 { font-size:1.5em; }
    .container { padding:20px; }
    .form-card, .history-card { background:white; padding:20px; border-radius:10px; 
      box-shadow:0 2px 6px rgba(0,0,0,0.2); margin-bottom:20px; }
    label { display:block; margin-top:10px; }
    input, select, textarea { width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc; }
    button { margin:5px; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; }
    button.primary { background:#003366; color:white; }
    button.secondary { background:#ccc; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th { background:#003366; color:white; padding:10px; }
    td { border:1px solid #ddd; padding:8px; }
    tr:nth-child(even){ background:#f9f9f9; }
    tr:hover { background:#eef; }
  </style>
</head>
<body>
<header>
  <img src="logo.png" alt="Logo">
  <h1>Suivi des Incidents - UP MRE</h1>
</header>

<div class="container">
  <div class="form-card" id="formSection">
    <h2>Nouvel Incident</h2>
    <label>Lieu <select id="lieu"></select></label>
    <label>Ã‰quipe <select id="equipe"></select></label>
    <label>Date <input type="date" id="date"></label>
    <label>Astreinte <select id="astreinte"></select></label>
    <label>Type <select id="type"></select></label>
    <label>GravitÃ© <select id="gravite"></select></label>
    <label>Commentaire <textarea id="commentaire"></textarea></label>
    <label>Status <select id="status"></select></label>
    <button class="primary" onclick="ajouterIncident()">Enregistrer</button>
    <button class="secondary" onclick="afficherHistorique(incidents)">ðŸ“œ Voir lâ€™historique</button>
  </div>

  <div class="history-card" id="historySection" style="display:none;">
    <h2>Historique des incidents</h2>
    <label>Filtrer par lieu <select id="filtreLieu" onchange="filtrerHistorique()"></select></label>
    <div style="margin:10px 0;">
      <button class="secondary" onclick="exportCSV()">ðŸ“¥ Exporter en CSV</button>
      <button class="secondary" onclick="exportPDF()">ðŸ“„ Exporter en PDF</button>
    </div>
    <table id="tableHistorique">
      <thead>
        <tr>
          <th>Date crÃ©ation</th><th>Date clÃ´ture</th><th>Lieu</th><th>Ã‰quipe</th>
          <th>Type</th><th>GravitÃ©</th><th>Status</th><th>Commentaire</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="secondary" onclick="retour()">â¬… Retour</button>
  </div>
</div>

<script>
let incidents = [];
let lieux = ["Atelier","Sous-station","Voie 1","Voie 2"];
let equipes = ["Ã‰quipe A","Ã‰quipe B"];
let types = ["Ã‰lectrique","Signalisation","Voie"];
let gravites = ["Mineure","Majeure","Critique"];
let astreintes = ["Jour","Nuit"];
let statusList = ["Ouvert","Clos"];

function init(){
  remplirSelect("lieu", lieux);
  remplirSelect("equipe", equipes);
  remplirSelect("type", types);
  remplirSelect("gravite", gravites);
  remplirSelect("astreinte", astreintes);
  remplirSelect("status", statusList);
  remplirSelect("filtreLieu", ["Tous"].concat(lieux));
  chargerData();
}

function remplirSelect(id, data){
  const s=document.getElementById(id); s.innerHTML="";
  data.forEach(v=>{ const o=document.createElement("option"); o.value=v;o.text=v;s.appendChild(o);});
}

function ajouterIncident(){
  const inc={
    lieu:val("lieu"), equipe:val("equipe"), date:val("date"), astreinte:val("astreinte"),
    type:val("type"), gravite:val("gravite"), commentaire:val("commentaire"), status:val("status"),
    createdAt:new Date().toISOString().slice(0,10),
    closureDate: val("status")==="Clos"? new Date().toISOString().slice(0,10):""
  };
  incidents.push(inc); saveData(); alert("Incident ajoutÃ©");
}

function val(id){return document.getElementById(id).value;}

function afficherHistorique(data){
  document.getElementById("formSection").style.display="none";
  document.getElementById("historySection").style.display="block";
  const tbody=document.querySelector("#tableHistorique tbody"); tbody.innerHTML="";
  data.forEach((inc,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${inc.createdAt||""}</td>
      <td>${inc.closureDate||""}</td>
      <td>${inc.lieu||""}</td>
      <td>${inc.equipe||""}</td>
      <td>${inc.type||""}</td>
      <td>${inc.gravite||""}</td>
      <td>${inc.status||""}</td>
      <td>${inc.commentaire||""}</td>
      <td>${inc.status==="Ouvert"? `<button class="primary" onclick="cloturerIncident(${idx})">ClÃ´turer</button>`:"âœ…"}</td>
    `;
    tbody.appendChild(tr);
  });
}

function cloturerIncident(index){
  incidents[index].status="Clos";
  incidents[index].closureDate=new Date().toISOString().slice(0,10);
  saveData(); afficherHistorique(incidents);
}

function retour(){
  document.getElementById("formSection").style.display="block";
  document.getElementById("historySection").style.display="none";
}

function filtrerHistorique(){
  const f=document.getElementById("filtreLieu").value;
  if(f==="Tous") afficherHistorique(incidents);
  else afficherHistorique(incidents.filter(i=>i.lieu===f));
}

function saveData(){
  localStorage.setItem("incidents", JSON.stringify(incidents));
}

function chargerData(){
  const d=localStorage.getItem("incidents");
  if(d) incidents=JSON.parse(d);
}

function exportCSV(){
  let csv = "Date crÃ©ation;Date clÃ´ture;Lieu;Ã‰quipe;Type;GravitÃ©;Status;Commentaire\n";
  incidents.forEach(i=>{
    csv += `${i.createdAt||""};${i.closureDate||""};${i.lieu||""};${i.equipe||""};${i.type||""};${i.gravite||""};${i.status||""};"${i.commentaire||""}"\n`;
  });
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "incidents.csv"; a.click();
}

function exportPDF(){
  const printWindow = window.open("", "", "width=800,height=600");
  printWindow.document.write("<html><head><title>Incidents</title></head><body>");
  printWindow.document.write("<h2>Historique des incidents</h2>");
  printWindow.document.write(document.getElementById("tableHistorique").outerHTML);
  printWindow.document.write("</body></html>");
  printWindow.document.close();
  printWindow.print();
}

window.onload=init;
</script>
</body>
</html>
